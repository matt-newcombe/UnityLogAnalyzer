<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unity Log Analyzer</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìä</text></svg>">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="static/js/lib/dexie.min.js"></script>
    
    <!-- Core Infrastructure -->
    <script src="static/js/core/app-context.js"></script>
    
    <!-- Core Database (non-module, loads first) -->
    <!-- Database Core: schema, versioning, connection management -->
    <script src="static/js/database/database-core.js"></script>
    <!-- Query Classes: specialized database queries -->
    <script src="static/js/database/queries/summary-query.js"></script>
    <script src="static/js/database/queries/asset-queries.js"></script>
    <script src="static/js/database/queries/folder-analysis.js"></script>
    <script src="static/js/database/queries/process-queries.js"></script>
    <!-- Timeline Builders -->
    <script src="static/js/database/timeline/timeline-positioner.js"></script>
    <script src="static/js/database/timeline/import-chunk-builder.js"></script>
    <script src="static/js/database/timeline/operation-builder.js"></script>
    <script src="static/js/database/timeline/cache-block-builder.js"></script>
    <script src="static/js/database/timeline/worker-timeline-builder.js"></script>
    <script src="static/js/database/database-timeline.js"></script>
    <!-- Log Lines Query -->
    <script src="static/js/database/database-log-lines.js"></script>
    <!-- Main Database Facade (extends Core, uses Query classes) -->
    <script src="static/js/database/database.js"></script>
    <script src="static/js/core/api-client.js"></script>
    
    <!-- Refactored Modules (ES modules, load async but export to window) -->
    <script type="module" src="static/js/core/formatters.js"></script>
    <script type="module" src="static/js/core/state.js"></script>
    <script type="module" src="static/js/core/dom-utils.js"></script>
    <script type="module" src="static/js/charts/colors.js"></script>
    <script type="module" src="static/js/charts/tooltips.js"></script>
    <script type="module" src="static/js/charts/formatters.js"></script>
    <script type="module" src="static/js/charts/config-builders.js"></script>
    <script type="module" src="static/js/charts/data-processors.js"></script>
    <script type="module" src="static/js/charts/base-chart.js"></script>
    <script type="module" src="static/js/charts/chart-loaders.js"></script>
    <script type="module" src="static/js/components/tables/context-menu.js"></script>
    <script type="module" src="static/js/components/tables/assets-table.js"></script>
    <script type="module" src="static/js/components/tables/folder-table.js"></script>
    <script type="module" src="static/js/components/tables/mode-time-table.js"></script>
    <script type="module" src="static/js/components/tables/pipeline-table.js"></script>
    <script type="module" src="static/js/components/tables/operations-table.js"></script>
    <script type="module" src="static/js/components/tables/slowest-assets-table.js"></script>
    <script type="module" src="static/js/components/timeline/tooltip.js"></script>
    <script type="module" src="static/js/components/timeline/renderer.js"></script>
    <script type="module" src="static/js/components/timeline/index.js"></script>
    <script type="module" src="static/js/views/overview.js"></script>
    <script type="module" src="static/js/views/navigation.js"></script>
    
    <!-- Central Module Registry - registers all ES module exports to window -->
    <script type="module" src="static/js/core/module-registry.js"></script>
    
    <!-- Legacy Scripts (still needed for parsing, log viewer, and live monitoring) -->
    <script src="static/js/components/log-viewer/log-viewer.js"></script>
    <script src="static/js/features/slack-integration.js"></script>
    <script src="static/js/core/dashboard.js"></script>
    <script src="static/js/data/asset-mappings.js"></script>
    <script src="static/js/parser/parsing-database-operations.js"></script>
    <script type="module" src="static/js/parser/timeline-normalizer.js"></script>
    <script type="module" src="static/js/parser/log-parser.js"></script>
    <script src="static/js/components/log-parser/log-parser-page.js"></script>
    <script type="module" src="static/js/components/tables/cache-server-blocks.js"></script>
    <script type="module" src="static/js/live-monitor/index.js"></script>
    <script src="static/js/live-monitor/file-watcher-setup.js"></script>
    
    <!-- Module initialization - runs after all modules are loaded -->
    <script type="module">
        // This module script runs after all other modules have loaded
        window.modulesLoaded = true;
        if (typeof window.initDashboard === 'function') {
            window.initDashboard();
        }
    </script>
    <link rel="stylesheet" href="static/css/dashboard.css">
    <script>
        // Register Chart.js datalabels plugin and load version
        document.addEventListener('DOMContentLoaded', () => {
            Chart.register(ChartDataLabels);
            
            // Load version number
            fetch('version.txt')
                .then(response => response.text())
                .then(text => {
                    const version = text.trim();
                    const versionElements = document.querySelectorAll('#version-display');
                    versionElements.forEach(el => {
                        if (el) el.textContent = `Version: ${version}`;
                    });
                })
                .catch(error => {
                    console.warn('Failed to load version:', error);
                    const versionElements = document.querySelectorAll('#version-display');
                    versionElements.forEach(el => {
                        if (el) el.textContent = 'Version: Unknown';
                    });
                });
        });
    </script>
</head>

<body>
    <div class="container">
        <header>
            <div class="header-content">
                <h1> <svg width="128" height="80" viewBox="0 0 120 30"
                        style="vertical-align: middle; margin-right: 15px; display: inline-block;"
                        xmlns="http://www.w3.org/2000/svg">
                        <rect fill="#e4e4e4" x="0" y="0" width="120" height="30" />
                        <rect fill="#2d2d30" x="8.5" y="7.5" width="3" height="15" />
                        <rect fill="#2d2d30" x="14.5" y="7.5" width="3" height="15" />
                        <rect fill="#2d2d30" x="20.5" y="7.5" width="3" height="15" />
                        <rect fill="#2d2d30" x="26.5" y="7.5" width="3" height="15" />
                        <rect fill="#2d2d30" x="32.5" y="7.5" width="3" height="15" />
                        <rect fill="#2d2d30" x="38.5" y="7.5" width="3" height="15" />
                        <rect fill="#2d2d30" x="44.5" y="7.5" width="3" height="15" />
                        <rect fill="#2d2d30" x="50.5" y="7.5" width="3" height="15" />
                        <rect fill="#2d2d30" x="56.5" y="7.5" width="3" height="15" />
                        <rect fill="#2d2d30" x="62.5" y="7.5" width="3" height="15" />
                        <rect fill="#2d2d30" x="68.5" y="7.5" width="3" height="15" />
                        <rect fill="#2d2d30" x="74.5" y="7.5" width="3" height="15" />
                        <rect fill="#2d2d30" x="80.5" y="7.5" width="3" height="15" />
                        <rect fill="#2d2d30" x="86.5" y="7.5" width="3" height="15" />
                        <rect fill="#2d2d30" x="92.5" y="7.5" width="3" height="15" />
                        <rect fill="#2d2d30" x="98.5" y="7.5" width="3" height="15" />
                    </svg> Unity Log Analyzer<span id="project-name"
                        style="color: #667eea; font-size: 0.6em; margin-left: 15px;"></span><span id="unity-version"
                        style="color: #999; font-size: 0.5em; margin-left: 10px;"></span></h1>
                <p class="subtitle">Interactive visualization of Unity Editor.log performance data</p>
                <div style="display: flex; align-items: center; gap: 15px; margin-top: 5px;">
                    <p id="version-display" style="font-size: 0.85em; color: #999; margin: 0;">Version: Loading...</p>
                </div>
            </div>
        </header>

        <!-- Action Buttons Bar -->
        <div id="action-buttons-bar" class="action-buttons-bar">
            <div class="action-buttons-group">
                <button onclick="openLogParser()" class="action-btn action-btn-primary" id="parse-log-btn">üìÅ Parse Log
                    File</button>
                <button onclick="toggleWatchEditorLog()" class="action-btn action-btn-secondary"
                    id="watch-editor-log-btn" style="display: none;">üëÅÔ∏è Watch Editor Log</button>
                <button onclick="loadExampleLog('fantasy-kingdom')" class="action-btn action-btn-info" data-tooltip="Loads a log from our public Unity projects to let you explore the interface">üè∞ Parse Fantasy Kingdom.log</button>
                <button onclick="loadExampleLog('time-ghost')" class="action-btn action-btn-info" data-tooltip="Loads a log from our public Unity projects to let you explore the interface">üëª Parse Time Ghosts.log</button>
            </div>
            <div id="timestamp-status" style="display: none; flex: 1; margin: 0 20px;"></div>
            <div class="action-buttons-group">
                <button onclick="clearDashboardAndDatabase()" class="action-btn action-btn-warning" id="clear-btn">üóëÔ∏è
                    Clear All</button>
            </div>
        </div>

        <div id="monitoring-status" class="monitoring-status" style="display: none; margin-bottom: 20px;">
            <span class="monitoring-indicator">
                <span class="monitoring-light"></span>
            </span>
            <span class="monitoring-path" id="monitoring-path-text"></span>
            <span id="last-message-time"
                style="margin-left: 12px; font-size: 0.85em; color: #666; max-width: 600px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"></span>
        </div>

        <div id="error" class="error" style="display: none;"></div>

        <div id="stats" class="stats-grid" style="display: none;"></div>
        <div id="charts" class="charts-grid" style="display: none;"></div>
        <div id="tables"></div>

        <div id="slack-button-container" style="text-align: center; margin: 40px 0; padding: 20px;">
            <button class="nav-button" onclick="copySlackHeadlines()"
                style="background: #667eea; border: none; cursor: grab; height: 44px; padding: 0 16px;"
                id="slack-copy-btn">üìã Copy Headlines for Slack</button>
        </div>
    </div>

    <!-- Log Parser Overlay -->
    <div id="log-parser-overlay" class="log-viewer-overlay" style="display: none;">
        <div id="log-parser-panel"
            style="position: relative; background: white; border-radius: 8px; width: 900px; max-height: 90vh; overflow-y: auto; margin: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.15);">
            <div style="padding: 20px; position: relative;">
                <button class="log-viewer-close" onclick="cancelLogParser()"
                    style="position: absolute; top: 15px; right: 15px; width: 28px; height: 28px; font-size: 1.2em; background: transparent; border: none; color: #666; cursor: grab; border-radius: 4px; transition: background 0.2s; z-index: 10;"
                    onmouseover="this.style.background='#f0f0f0'"
                    onmouseout="this.style.background='transparent'">√ó</button>
                <div class="file-upload-area" id="parser-upload-area"
                    onclick="document.getElementById('parser-file-input').click()"
                    style="border: 2px dashed #667eea; border-radius: 8px; padding: 40px; text-align: center; background: #f8f9fa; margin-bottom: 30px; cursor: grab; transition: all 0.3s ease;">
                    <div style="font-size: 3em; margin-bottom: 20px;">üìÑ</div>
                    <h2>Click to select a log file</h2>
                    <p style="color: #999; margin-top: 10px;">or drag and drop your .log file here</p>
                    <input type="file" id="parser-file-input" accept=".log" style="display: none;">
                </div>

                <div id="parser-progress-container" style="display: none; margin-top: 30px;">
                    <div id="parser-output-toggle-container" style="margin-bottom: 15px;">
                        <button id="parser-output-toggle-btn" onclick="toggleParserOutput()"
                            style="padding: 6px 12px; background: #f0f0f0; border: 1px solid #ddd; border-radius: 4px; cursor: grab; font-size: 0.85em; color: #666; transition: background 0.2s;"
                            onmouseover="this.style.background='#e0e0e0'" onmouseout="this.style.background='#f0f0f0'">
                            Show output
                        </button>
                    </div>

                    <div id="parser-loading-progress"
                        style="display: none; background: #f5f5f5; border-radius: 4px; padding: 15px; max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 0.9em; white-space: pre-wrap; margin-bottom: 15px;">
                    </div>

                    <div id="parser-progress-bars-container" style="margin-top: 20px;"></div>
                </div>

                <div id="parser-error-container"
                    style="display: none; margin-top: 20px; padding: 15px; background: #ffebee; border-left: 4px solid #f44336; border-radius: 4px; color: #c62828;">
                </div>

                <div id="parser-completion-container"
                    style="display: none; margin-top: 30px; text-align: center; padding: 30px; background: #e8f5e9; border-radius: 8px; border: 2px solid #4CAF50;">
                    <h2 style="color: #2e7d32; margin-bottom: 15px;">‚úì Parsing Complete!</h2>
                    <p style="color: #666; margin-bottom: 20px;">Your log file has been successfully parsed and stored
                        in IndexedDB.</p>
                    <p id="parser-background-message"
                        style="color: #667eea; margin-bottom: 20px; font-weight: 500; display: none;">
                        Log lines are being stored in the background. You can use the dashboard while this completes.
                    </p>
                    <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                        <button
                            onclick="closeLogParserAndRefresh()"
                            class="nav-button"
                            style="background: #4CAF50; border: none; cursor: grab; height: 44px; padding: 0 24px; display: inline-flex; align-items: center; text-decoration: none; color: white; font-weight: bold; border-radius: 4px;">
                            Close & Refresh Dashboard
                        </button>
                        <button onclick="resetParser()" class="nav-button"
                            style="background: #667eea; border: none; cursor: grab; height: 44px; padding: 0 24px; display: inline-flex; align-items: center; text-decoration: none; color: white; font-weight: bold; border-radius: 4px;">
                            Parse Another Log File
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Log Viewer Overlay -->
    <div id="log-viewer-overlay" class="log-viewer-overlay" onclick="if(event.target === this) closeLogViewer();">
        <div id="log-viewer-panel" class="log-viewer-panel">
            <div class="log-viewer-header">
                <h2>üìÑ Log Viewer</h2>
                <button class="log-viewer-close" onclick="closeLogViewer();" title="Close">√ó</button>
            </div>
            <div class="log-viewer-controls">
                <div class="log-viewer-search">
                    <input type="text" id="log-viewer-search" placeholder="Search log... (press Enter)"
                        onkeypress="if(event.key === 'Enter') searchLogViewer(event.target.value);">
                </div>
                <div class="log-viewer-filters">
                    <button class="log-viewer-filter-btn active" data-filter="all"
                        onclick="filterLogViewer('all')">All</button>
                    <button class="log-viewer-filter-btn" data-filter="error"
                        onclick="filterLogViewer('error')">Errors</button>
                    <button class="log-viewer-filter-btn" data-filter="warning"
                        onclick="filterLogViewer('warning')">Warnings</button>
                    <button class="log-viewer-filter-btn" data-filter="import"
                        onclick="filterLogViewer('import')">Imports</button>
                    <button class="log-viewer-filter-btn" data-filter="pipeline"
                        onclick="filterLogViewer('pipeline')">Pipeline</button>
                </div>
            </div>
            <div id="log-viewer-loading" class="log-viewer-loading" style="display: none;">Loading log...</div>
            <div id="log-viewer-content" class="log-viewer-content"></div>
            <div id="log-viewer-stats" class="log-viewer-stats">
                <span>Total lines: 0</span>
                <span>Showing: 0 lines</span>
            </div>
        </div>
    </div>
</body>

</html>
